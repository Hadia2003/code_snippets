pipeline {
    agent any

    environment {
        // --- UPDATE THESE ---
        APP_REPO      = 'https://github.com/yourusername/flaskblog_ci.git'
        APP_BRANCH    = 'main'
        TEST_REPO     = 'https://github.com/yourusername/flaskblog-selenium-tests.git'
        TEST_BRANCH   = 'main'
        COMPOSE_FILE  = 'docker-compose.yml'
        PROJECT_NAME  = 'flaskblog_ci'
        PYTHON_IMAGE  = 'python:3.9-slim'
        // --------------------
    }

    stages {
        stage('Checkout Application') {
            steps {
                git branch: APP_BRANCH, url: APP_REPO
            }
        }

        stage('Clean Existing Containers') {
            steps {
                // Tear down any old compose stack
                sh "docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} down --remove-orphans"
                // Force-remove any stray containers
                sh """
                  docker rm -f ${PROJECT_NAME}_web || true
                  docker rm -f ${PROJECT_NAME}_db  || true
                """
            }
        }

        stage('Build & Deploy') {
            steps {
                sh "docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} up -d --build"
            }
        }

        stage('Wait for Flask to Start') {
            steps {
                echo 'Waiting 60 seconds for the Flask app to become healthyâ€¦'
                sh 'sleep 60'
            }
        }

        stage('Checkout Selenium Tests') {
            steps {
                dir('selenium-tests') {
                    git branch: TEST_BRANCH, url: TEST_REPO
                }
            }
        }

        stage('Run Selenium Tests') {
            steps {
                script {
                    docker.image(PYTHON_IMAGE)
                          .inside('--network host --shm-size=2g') {
                              // install your test deps
                              sh 'pip install -r requirements.txt'
                              // run pytest and generate JUnit XML
                              sh 'pytest --junitxml=reports/results.xml'
                          }
                }
            }
        }
    }

    post {
        always {
            // Publish test results (even if there are no tests)
            junit testResults: 'selenium-tests/reports/*.xml', allowEmptyResults: true
            // Optional: tear down your compose stack
            sh "docker compose -p ${PROJECT_NAME} -f ${COMPOSE_FILE} down"
        }
    }
}



// pipeline {
//   agent any

//   stages {
//     stage('Checkout') {
//       steps {
//         // Clone the repo
//         git url: 'https://github.com/Hadia2003/code_snippets.git', branch: 'master'
//       }
//     }
//     stage('Build & Deploy') {
//       steps {
//         // Navigate into the Flask blog directory
//         dir('Python/Flask_Blog/04-Database') {
//           // Tear down any existing containers & volumes, then rebuild from scratch
//           sh '''
//             docker-compose -p flaskblog_ci -f docker-compose.yml down -v || true
//             docker-compose -p flaskblog_ci -f docker-compose.yml up -d --build --force-recreate
//           '''
//         }
//       }
//     }
//   }

//   post {
//     always {
//       // Print out the status of the running containers for debugging
//       dir('Python/Flask_Blog/04-Database') {
//         sh 'docker-compose -p flaskblog_ci -f docker-compose.yml ps'
//       }
//     }
//   }
// }
